{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 48, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/projet-app-dvf/lib/db.js"],"sourcesContent":["import { Pool } from 'pg';\r\n\r\nlet pool;\r\n\r\nexport function getPool() {\r\n  if (!pool) {\r\n    // Support de DATABASE_URL en priorité, sinon variables séparées\r\n    let config;\r\n\r\n    if (process.env.DATABASE_URL) {\r\n      // Utiliser la chaîne de connexion complète\r\n      config = {\r\n        connectionString: process.env.DATABASE_URL,\r\n        max: 20,\r\n        idleTimeoutMillis: 30000,\r\n        connectionTimeoutMillis: 2000,\r\n        ssl: process.env.DB_SSL === 'true' ? { rejectUnauthorized: false } : false\r\n      };\r\n    } else {\r\n      // Utiliser les variables d'environnement séparées\r\n      const host = process.env.DB_HOST || 'localhost';\r\n      const user = process.env.DB_USER;\r\n      const password = process.env.DB_PASSWORD;\r\n      const database = process.env.DB_NAME;\r\n      const port = parseInt(process.env.DB_PORT || '5432', 10);\r\n\r\n      // Vérification des paramètres requis\r\n      if (!user || !password || !database) {\r\n        throw new Error(\r\n          'Configuration de base de données manquante. ' +\r\n          'Veuillez définir DB_USER, DB_PASSWORD, DB_NAME dans .env.local ' +\r\n          'ou utiliser DATABASE_URL.'\r\n        );\r\n      }\r\n\r\n      config = {\r\n        host,\r\n        user,\r\n        password,\r\n        database,\r\n        port,\r\n        max: 20,\r\n        idleTimeoutMillis: 30000,\r\n        connectionTimeoutMillis: 2000,\r\n        ssl: process.env.DB_SSL === 'true' ? { rejectUnauthorized: false } : false\r\n      };\r\n    }\r\n\r\n    pool = new Pool(config);\r\n\r\n    // Gestion des erreurs de connexion\r\n    pool.on('error', (err) => {\r\n      console.error('Erreur inattendue sur le pool PostgreSQL:', err);\r\n    });\r\n\r\n    // Test de connexion au démarrage (optionnel, pour debug)\r\n    if (process.env.NODE_ENV === 'development') {\r\n      pool.query('SELECT NOW()')\r\n        .then(() => {\r\n          console.log('✅ Connexion PostgreSQL établie avec succès');\r\n        })\r\n        .catch((err) => {\r\n          console.error('❌ Erreur de connexion PostgreSQL:', err.message);\r\n          console.error('Vérifiez vos variables d\\'environnement dans .env.local');\r\n        });\r\n    }\r\n  }\r\n  return pool;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,IAAI;AAEG,SAAS;IACd,IAAI,CAAC,MAAM;QACT,gEAAgE;QAChE,IAAI;QAEJ,IAAI,QAAQ,GAAG,CAAC,YAAY,EAAE;YAC5B,2CAA2C;YAC3C,SAAS;gBACP,kBAAkB,QAAQ,GAAG,CAAC,YAAY;gBAC1C,KAAK;gBACL,mBAAmB;gBACnB,yBAAyB;gBACzB,KAAK,QAAQ,GAAG,CAAC,MAAM,KAAK,SAAS;oBAAE,oBAAoB;gBAAM,IAAI;YACvE;QACF,OAAO;YACL,kDAAkD;YAClD,MAAM,OAAO,QAAQ,GAAG,CAAC,OAAO,IAAI;YACpC,MAAM,OAAO,QAAQ,GAAG,CAAC,OAAO;YAChC,MAAM,WAAW,QAAQ,GAAG,CAAC,WAAW;YACxC,MAAM,WAAW,QAAQ,GAAG,CAAC,OAAO;YACpC,MAAM,OAAO,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI,QAAQ;YAErD,qCAAqC;YACrC,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,UAAU;gBACnC,MAAM,IAAI,MACR,iDACA,oEACA;YAEJ;YAEA,SAAS;gBACP;gBACA;gBACA;gBACA;gBACA;gBACA,KAAK;gBACL,mBAAmB;gBACnB,yBAAyB;gBACzB,KAAK,QAAQ,GAAG,CAAC,MAAM,KAAK,SAAS;oBAAE,oBAAoB;gBAAM,IAAI;YACvE;QACF;QAEA,OAAO,IAAI,qJAAI,CAAC;QAEhB,mCAAmC;QACnC,KAAK,EAAE,CAAC,SAAS,CAAC;YAChB,QAAQ,KAAK,CAAC,6CAA6C;QAC7D;QAEA,yDAAyD;QACzD,wCAA4C;YAC1C,KAAK,KAAK,CAAC,gBACR,IAAI,CAAC;gBACJ,QAAQ,GAAG,CAAC;YACd,GACC,KAAK,CAAC,CAAC;gBACN,QAAQ,KAAK,CAAC,qCAAqC,IAAI,OAAO;gBAC9D,QAAQ,KAAK,CAAC;YAChB;QACJ;IACF;IACA,OAAO;AACT"}},
    {"offset": {"line": 123, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/projet-app-dvf/app/api/search/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { unstable_cache } from 'next/cache';\r\nimport { getPool } from '@/lib/db';\r\n\r\n// Fonction de validation des paramètres\r\nfunction validateParams(lat, lng, radius) {\r\n  const latNum = parseFloat(lat);\r\n  const lngNum = parseFloat(lng);\r\n  const radiusNum = parseInt(radius, 10);\r\n\r\n  // Validation des coordonnées\r\n  if (isNaN(latNum) || isNaN(lngNum)) {\r\n    return { valid: false, error: 'Coordonnées invalides' };\r\n  }\r\n\r\n  if (latNum < -90 || latNum > 90 || lngNum < -180 || lngNum > 180) {\r\n    return { valid: false, error: 'Coordonnées hors limites' };\r\n  }\r\n\r\n  // Validation du rayon (minimum 50m, maximum 5000m)\r\n  if (isNaN(radiusNum) || radiusNum < 50) {\r\n    return { valid: false, error: 'Rayon minimum de 50m requis' };\r\n  }\r\n\r\n  if (radiusNum > 5000) {\r\n    return { valid: false, error: 'Rayon maximum de 5000m' };\r\n  }\r\n\r\n  return { valid: true, lat: latNum, lng: lngNum, radius: radiusNum };\r\n}\r\n\r\n// Fonction de requête avec cache (clé basée sur les paramètres)\r\nasync function getCachedTransactions(lat, lng, radius, limit, offset) {\r\n  const cacheKey = `dvf-search-${lat}-${lng}-${radius}-${limit}-${offset}`;\r\n  \r\n  return unstable_cache(\r\n    async () => {\r\n      const pool = getPool();\r\n      \r\n      // Requête optimisée avec projection minimale et index spatial (PostgreSQL/PostGIS)\r\n      const query = `\r\n        SELECT \r\n          id_mutation,\r\n          MAX(date_mutation) as date_mutation,\r\n          MAX(valeur_fonciere) as valeur_fonciere,\r\n          MAX(adresse_numero) as adresse_numero,\r\n          MAX(adresse_nom_voie) as adresse_nom_voie,\r\n          MAX(code_postal) as code_postal,\r\n          MAX(nom_commune) as nom_commune,\r\n          MAX(id_parcelle) as id_parcelle,\r\n          COALESCE(STRING_AGG(DISTINCT type_local, ', '), 'Terrain') as type_local,\r\n          SUM(surface_reelle_bati) as surface_reelle_bati, \r\n          MAX(surface_terrain) as surface_terrain,\r\n          MAX(latitude) as latitude,\r\n          MAX(longitude) as longitude\r\n        FROM transactions\r\n        WHERE ST_DWithin(\r\n          geom::geography,\r\n          ST_SetSRID(ST_MakePoint($1, $2), 4326)::geography,\r\n          $3\r\n        )\r\n        AND (\r\n          type_local IN ('Maison', 'Appartement', 'Local industriel. commercial ou assimilé') \r\n          OR \r\n          (type_local IS NULL AND surface_terrain > 0)\r\n        ) \r\n        GROUP BY id_mutation\r\n        ORDER BY date_mutation DESC\r\n        LIMIT $4 OFFSET $5;\r\n      `;\r\n\r\n      const startTime = Date.now();\r\n      const result = await pool.query(query, [lng, lat, radius, limit, offset]);\r\n      const queryTime = Date.now() - startTime;\r\n      \r\n      // Log de performance (seulement en développement)\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log(`[Performance] Requête exécutée en ${queryTime}ms`);\r\n      }\r\n\r\n      return result.rows;\r\n    },\r\n    [cacheKey],\r\n    {\r\n      revalidate: 3600, // Cache pendant 1 heure\r\n      tags: ['dvf-search']\r\n    }\r\n  )();\r\n}\r\n\r\n// Fonction pour obtenir le nombre total de résultats (pour la pagination)\r\nasync function getTotalCount(lat, lng, radius) {\r\n  const cacheKey = `dvf-count-${lat}-${lng}-${radius}`;\r\n  \r\n  return unstable_cache(\r\n    async () => {\r\n      const pool = getPool();\r\n      \r\n      const countQuery = `\r\n        SELECT COUNT(DISTINCT id_mutation) as total\r\n        FROM transactions\r\n        WHERE ST_DWithin(\r\n          geom::geography,\r\n          ST_SetSRID(ST_MakePoint($1, $2), 4326)::geography,\r\n          $3\r\n        )\r\n        AND (\r\n          type_local IN ('Maison', 'Appartement', 'Local industriel. commercial ou assimilé') \r\n          OR \r\n          (type_local IS NULL AND surface_terrain > 0)\r\n        );\r\n      `;\r\n\r\n      const result = await pool.query(countQuery, [lng, lat, radius]);\r\n      return parseInt(result.rows[0].total, 10);\r\n    },\r\n    [cacheKey],\r\n    {\r\n      revalidate: 3600,\r\n      tags: ['dvf-count']\r\n    }\r\n  )();\r\n}\r\n\r\nexport async function GET(request) {\r\n  const { searchParams } = new URL(request.url);\r\n  const lat = searchParams.get('lat');\r\n  const lng = searchParams.get('lng');\r\n  const radiusParam = searchParams.get('radius');\r\n  const pageParam = searchParams.get('page');\r\n  const limitParam = searchParams.get('limit');\r\n\r\n  // Validation des paramètres requis\r\n  if (!lat || !lng) {\r\n    return NextResponse.json(\r\n      { error: 'Coordonnées manquantes (lat et lng requis)' },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  // Validation et normalisation des paramètres\r\n  const validation = validateParams(lat, lng, radiusParam || 500);\r\n  if (!validation.valid) {\r\n    return NextResponse.json(\r\n      { error: validation.error },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  const { lat: latNum, lng: lngNum, radius } = validation;\r\n\r\n  // Pagination\r\n  const limit = Math.min(parseInt(limitParam || '100', 10), 500); // Max 500 résultats par page\r\n  const page = Math.max(parseInt(pageParam || '1', 10), 1);\r\n  const offset = (page - 1) * limit;\r\n\r\n  try {\r\n    // Exécution en parallèle : données + count total\r\n    const [transactions, totalCount] = await Promise.all([\r\n      getCachedTransactions(latNum, lngNum, radius, limit, offset),\r\n      getTotalCount(latNum, lngNum, radius)\r\n    ]);\r\n\r\n    return NextResponse.json({\r\n      data: transactions,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total: totalCount,\r\n        totalPages: Math.ceil(totalCount / limit),\r\n        hasMore: offset + transactions.length < totalCount\r\n      },\r\n      meta: {\r\n        lat: latNum,\r\n        lng: lngNum,\r\n        radius,\r\n        cached: true // Indique que les données peuvent être en cache\r\n      }\r\n    }, {\r\n      headers: {\r\n        'Cache-Control': 'public, s-maxage=3600, stale-while-revalidate=86400'\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[API Error]', {\r\n      message: error.message,\r\n      stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,\r\n      params: { lat: latNum, lng: lngNum, radius }\r\n    });\r\n\r\n    return NextResponse.json(\r\n      { \r\n        error: 'Erreur lors de la récupération des données',\r\n        message: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}